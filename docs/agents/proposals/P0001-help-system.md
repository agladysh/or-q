# P0001: Help System

Status: **DRAFT**

> [!WARNING] This document is partially generated by AI for AI and may contain mistakes.

## Summary

This proposal outlines the implementation of a comprehensive help system for OR-Q.

## Commands

### `@or-q/plugin-help`

All help commands replace input with their output.

- `help`: Lists all commands with the `help-command` tag in alphabetic order, with their desriptions.
- `help-commands`: List all commands with their descriptions, grouped by plugin
- `help-commands-by-tag "<tag>"`: List all commands with a tag. Tag is arbitrary.
- `help-command "<command>"`: Prints command description and usage string (TBD: plan how to refactor the usage string to
  a parameter)
- `help-plugins`: Lists all available plugins with their descriptions, sorted alphabetically
- `help-plugin "<plugin.name>"`: Shows detailed information about a specific plugin including its commands and assets
- `help-assets`: Lists all available assets (YAML scripts and other files) with their descriptions and plugin sources

Note that `help-asset` currently makes no sense, as there is no additional information to display

### `@or-q/plugin-discover`

- `discover`: Replaces input with JSON array of all commands with `discovery-command` tag in the form:
  `{"name":"command","description":"command description"}`
- `discover-commands`: Returns JSON array of all commands with full metadata including description, usage, tags, and
  plugin source
- `discover-plugins`: Returns JSON array of all plugins with their metadata, commands, and assets
- `discover-assets`: Returns JSON array of all assets with their metadata, content paths, and plugin sources

Note filtration commands are redundant, users may filter themselves arbitrarily with `jp`.

### `@or-q/plugin-yaml-script`

Support optional `description` field on assets to show in help

- `help-scripts`: Lists all available YAML scripts with their descriptions and usage information
- `help-script "<script>"`: Shows detailed help for a specific script including description, required plugins, and
  parameters
- `discover-scripts`: Returns JSON array of all YAML scripts with their metadata, requirements, and command structures
- `discover-script "<script>"`: displays full script YAML

### Other Plugins

#### Legacy Help-like Command Elimination

The following existing commands should be replaced by the new help/discover system:

**Commands to Replace with `help-*`** (stdout + pass-through pattern):

- `list-plugins` → `help-plugins`
- `list-assets` → `help-assets`
- `list-script-assets` → `help-scripts`

**Commands to Replace with `discover-*`** (JSON output pattern):

- `plugins-json` → `discover-plugins`
- `dump-macros` → `discover-macros` (plugin-specific)
- `dump-store` → `discover-store` (plugin-specific)

**Commands to Keep** (not help/discover related):

- `dump` (debugging tool for program arguments)
- Commands with similar names but different purposes

#### Help and Discover Commands

Adding new help and discover commands to other plugins is not in scope of this proposal.

## Reference Command Output Formats

Illustrative, not normative.

**`help` command output:**

```text
Available Commands:

Core Commands:
  help                 Show available help commands
  help-commands        List all commands grouped by plugin
  help-plugins         List all available plugins

Plugin Commands:
  echo                 Output the input unchanged
  print                Print input to stdout and pass through
  ...
```

**`discover` command output:**

```json
[
  { "name": "help", "description": "Show available help commands", "tags": ["help-command"] },
  { "name": "discover", "description": "List discovery commands as JSON", "tags": ["discovery-command"] }
  //...
]
```

**`help-plugins` command output:**

```text
Available Plugins:

@or-q/plugin-core
  Core functionality and debugging commands

@or-q/plugin-fetch
  HTTP request functionality with YAML configuration support

...
```

**`discover-plugins` command output:**

```jsonc
[
  {
    "name": "@or-q/plugin-core",
    "description": "Core functionality and debugging commands",
    "commands": ["echo", "print", "dump" /*...*/],
    "assets": [],
  },
  // ...
]
```

TBD all other commands from this proposal.

## Other Code Changes

Non-exhaustive:

- Remove `IPluginRuntime.usage()`
- Add `@or-q/cli` dependency on `@or-q/help`
- Add `description: pkg.description` to every plugin `index.ts`
- Add optional `tags` field on Command as array of strings
- Add mandatory `usage` field on Command, and refactor all commands to expose it
- Add appropriate lookup dictionaries to `PluginRuntime` class
- export `tagHelpCommand` constant from `@or-q/plugin-help` and use it in help command definitions
- export `tagDiscoverCommand` constant from `@or-q/plugin-discover` and use it in discover command definitions

## Design Principles

### 1. Programmatic Content Generation

All help commands are programmatic, using existing content:

- **Plugin metadata**: `Plugin.name` (existing) and `Plugin.description` (new field, re-export from Plugin's
  `package.json`)
- **Command descriptions**: Already present in command definitions
- **Runtime state**: Available plugins, commands, assets from runtime
- **No duplication**: No separate help content to maintain

### 2. Enhanced Command Metadata

Commands get an optional `tags` array for flexible categorization. Tags recognized by the help and discovery systems:

- `help-command`: Commands that provide help functionality
- `discovery-command`: Commands that provide discovery/metadata functionality

Plugins can use additional domain-specific tags as needed.

### 3. Separation of Concerns

- **Human-readable help**: `help` and `help-*` commands provide formatted, user-friendly output
- **Machine-readable data**: `discover` and `discover-*` commands provide structured data for programmatic use
- **Plugin-extensible**: Each plugin may export its own help and/or discovery commands

### 4. CLI Integration

When OR-Q is invoked with no arguments:

1. Output brief standard cli usage header
2. Check if `help` command exists in the runtime
3. If yes, execute it on general principles
4. If no, show a generic fallback message: `help command not available, install the @or-q/plugin-help npm package`

## Implementation Strategy

TBD

## Motivation

### Why This Approach

OR-Q's current help situation is problematic:

1. **User Onboarding**: New users cannot discover available functionality
2. **Plugin Discovery**: No way to understand what plugins provide
3. **Script Visibility**: YAML scripts are invisible without prior knowledge
4. **Developer Experience**: Plugin authors have no standard way to expose help
5. **Architectural Debt**: It is best to introduce breaking changes early

### Why Not Hierarchical Commands

A seemingly elegant alternative would be `help commands`, `help plugins`, etc. However, this is architecturally
impossible due to the way OR-Q's stack-based argument consumption is currently implemented:

The `help` command cannot determine if `commands` is an argument for the help command (e.g., "show me help about
commands") or a legitimate command name that should be left for the next pipeline stage.

## Future Work

After planned switch to the CS-correct program form, `help` command may become porcelain for other
`help-command-plumbing` commands, supporting the elegant alternative above.
