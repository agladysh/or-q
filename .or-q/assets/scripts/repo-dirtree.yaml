# TODO: Implement static cache populated/updated based on git repo and working copy changes

requires:
  - '@or-q/plugin-core'
  - '@or-q/plugin-fetch' # TODO: Migrate general openai conversation stuff from there and update this dependency
  - '@or-q/plugin-store'
  - '@or-q/plugin-jp'

commands:
  - run: fetch-gemini-2.5-flash-instruct
  - run: codebase

  - load: FILENAMES
  - dirtree
  - save: DIRTREE

  - $macro:
      - - $fetch-gemini-2.5-flash-instruct
        - You are a pedantic erudite best-of-field CTO, excelling in technical documentation
        - - t: | # markdown
              Your task is to annotate the project dirtree, provided below, based on the project codebase, also provided below.

              Study the codebase:
              <codebase>
              ${ load FILES }
              </codebase>

              When working with packages in a monorepo, take care to distinguish directory structure and package names,
              which may contain slashes. The annotated dirtree must reflect physical directory structure,
              not logical npm package naming structure. Use directory names, not package names.

              Read the original dirtree for the codebase:
              <dirtree>
              ${ load dirtree }
              </dirtree>

              Put annotations after colon on the same line as the annotated item. Example:

              ```
              ...
              ├─ pnpm-workspace.yaml: workspace packages in packages/*, lefthook is a built dependency
              ...
              ├─ packages/: workspace packages
              ...
              ```

              Respond with annotated dirtree, containing concise informative descriptions of the files and directories.

              The structure, order and naming of lines in your response must precisely match the original <dirtree/> content
              provided above. Go line by line and add only annotations.

              Your response will be processed by an automated system. Do not include any additional information,
              respond only with the raw annotated dirtree text, no xml tags or Markdown fence blocks ("```") are allowed.

  - prepend:
      - - t: | # markdown
            <!-- markdownlint-disable MD013-->

            # Project Directory Tree

            > [!WARNING] _This document was generated by an AI and may contain mistakes._

            - Generated-On: ${ shell "date +'%Y-%m-%d'"}
            - Generated-For: ${ shell "git describe --always"}
            - Generated-By: `pnpm or-q run repo-dirtree > docs/agents/dirtree.md`

            ```text
  - append: "\n```"
