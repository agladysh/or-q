# P0001: Help System

Status: **DRAFT**

> [!WARNING] This document is partially generated by AI for AI and may contain mistakes.

## Summary

This proposal outlines the implementation of a comprehensive help system for OR-Q.

## Commands

### `@or-q/plugin-help`

All help commands replace input with their output.

- `help`: Lists all commands with the `help-command` tag in alphabetic order, with their desriptions.
- `help-commands`: List all commands with their descriptions, grouped by plugin
- `help-commands-by-tag "<tag>"`: List all commands with a tag. Tag is arbitrary.
- `help-command "<command>"`: Prints command description and usage string
- `help-plugins`: Lists all available plugins with their descriptions, sorted alphabetically
- `help-plugin "<plugin.name>"`: Shows detailed information about a specific plugin including its commands and assets
- `help-assets`: Lists all available assets (YAML scripts and other files) with their descriptions and plugin sources

Note that `help-asset` currently makes no sense, as there is no additional information to display

### `@or-q/plugin-discover`

- `discover`: Replaces input with JSON array of all commands with `discovery-command` tag in the form:
  `{"name":"command","description":"command description"}`
- `discover-commands`: Returns JSON array of all commands with full metadata including description, usage, tags, and
  plugin source
- `discover-plugins`: Returns JSON array of all plugins with their metadata, commands, and assets
- `discover-assets`: Returns JSON array of all assets with their metadata, content paths, and plugin sources

Note filtration commands are redundant, users may filter themselves arbitrarily with `jp`.

### `@or-q/plugin-yaml-script`

Support optional `description` field on assets to show in help

- `help-scripts`: Lists all available YAML scripts with their descriptions and usage information
- `help-script "<script>"`: Shows detailed help for a specific script including description, required plugins, and
  parameters
- `discover-scripts`: Returns JSON array of all YAML scripts with their metadata, requirements, and command structures
- `discover-script "<script>"`: displays full script YAML

### Other Plugins

#### Legacy Help-like Command Elimination

The following existing commands should be replaced by the new help/discover system:

**Commands to Replace with `help-*`** (stdout + pass-through pattern):

- `list-plugins` → `help-plugins`
- `list-assets` → `help-assets`
- `list-script-assets` → `help-scripts`

**Commands to Replace with `discover-*`** (JSON output pattern):

- `plugins-json` → `discover-plugins`
- `dump-macros` → `discover-macros` (plugin-specific)
- `dump-store` → `discover-store` (plugin-specific)

**Commands to Keep** (not help/discover related):

- `dump` (debugging tool for program arguments)
- Commands with similar names but different purposes

#### Help and Discover Commands

Adding new help and discover commands to other plugins is not in scope of this proposal.

## Reference Command Output Formats

Illustrative abbreviated references.

> [!NOTE] JSON outputs are pretty-printed here for readability. Implementations should return compact newline-termidated
> representations.

**`help` command output:**

```text
Available Commands:

Help Commands:
  help                 Show available help commands
  help-commands        List all commands grouped by plugin
  help-plugins         List all available plugins
  help-assets          List all available assets with descriptions

Discovery Commands:
  discover             List discovery commands as JSON
  discover-commands    List all commands with full metadata as JSON
  discover-plugins     List all plugins with metadata as JSON
  discover-assets      List all assets with metadata as JSON

Core Commands:
  echo                 replaces input with argument
  print                prints trimmed argument to stdout, passing input forward
  tee                  outputs end-trimmed input to stdout, passes it along untrimmed
  clear                replaces input with empty string
  input                forwards input (useful for program arguments sometimes)
  default              if input is empty, replaces it with argument
```

**`discover` command output:**

```json
[
  { "name": "discover", "description": "List discovery commands as JSON", "tags": ["discovery-command"] },
  {
    "name": "discover-commands",
    "description": "List all commands with full metadata as JSON",
    "tags": ["discovery-command"]
  },
  { "name": "discover-plugins", "description": "List all plugins with metadata as JSON", "tags": ["discovery-command"] }
]
```

**`help-commands` command output:**

```text
Commands by Plugin:

@or-q/plugin-core:
  echo                 replaces input with argument
  print                prints trimmed argument to stdout, passing input forward
  tee                  outputs end-trimmed input to stdout, passes it along untrimmed
  clear                replaces input with empty string
  ...

@or-q/plugin-fetch:
  fetch                fetches data from a provided URL, with input as request body

@or-q/plugin-openrouter-api:
  completions          feeds input to the OpenRouter completions API, requires OPENROUTER_API_KEY env variable
  conversation         starts or continues a conversation
  models               replaces input with OpenRouter models list
  ...
```

**`help-plugins` command output:**

```text
Available Plugins:

@or-q/plugin-core            OR-Q Plugin: Core Commands

@or-q/plugin-fetch           OR-Q Plugin: Basic HTTP Support

@or-q/plugin-openrouter-api  OR-Q Plugin: OpenRouter API Integration
...
```

**`discover-plugins` command output:**

```json
[
  {
    "name": "@or-q/plugin-core",
    "description": "OR-Q Plugin: Core Commands",
    "commands": ["echo", "print", "tee", "clear" /*...*/],
    "assets": []
  },
  {
    "name": "@or-q/plugin-fetch",
    "description": "OR-Q Plugin: Basic HTTP Support",
    "commands": ["fetch"],
    "assets": ["scripts/fetch-openai-instruct.yaml", "scripts/fetch-test.yaml"]
  }
  // ...
]
```

**`help-assets` command output:**

```text
Available Assets:

@or-q/plugin-fetch:
  scripts/fetch-openai-instruct.yaml    OpenAI-compatible chat completion request macro
  scripts/fetch-test.yaml               Test script for fetch functionality with Ollama

@or-q/plugin-openrouter-api:
  scripts/chat.yaml                     Interactive chat session
  scripts/list-free-models.yaml         List free models from OpenRouter
  ...
```

**`discover-assets` command output:**

```json
[
  {
    "name": "scripts/fetch-openai-instruct.yaml",
    "plugin": "@or-q/plugin-fetch",
    "description": "OpenAI-compatible chat completion request macro",
    "path": "plugin:@or-q/plugin-fetch/scripts/fetch-openai-instruct.yaml"
  },
  {
    "name": "scripts/chat.yaml",
    "plugin": "@or-q/plugin-openrouter-api",
    "description": "Interactive chat session",
    "path": "plugin:@or-q/plugin-openrouter-api/scripts/chat.yaml"
  }
  // ...
]
```

**`help-scripts` command output:**

```text
Available Scripts:

fetch-openai-instruct        OpenAI-compatible chat completion request macro
chat                         Interactive chat session
list-free-models             List free models from OpenRouter
...
```

**`help-script "chat"` command output:**

```text
Script: chat
Plugin: @or-q/plugin-openrouter-api
Description: Interactive chat session

Usage: pnpm or-q run chat

Required Plugins:
  - @or-q/plugin-openrouter-api
  - @or-q/plugin-store

Environment Variables:
  - OPENROUTER_API_KEY (required for API access)
```

## Design Principles

### 1. Programmatic Content Generation

All help commands are programmatic, using existing content:

- **Plugin metadata**: `Plugin.name` (existing) and `Plugin.description` (new field, re-export from Plugin's
  `package.json`)
- **Command descriptions**: Already present in command definitions
- **Runtime state**: Available plugins, commands, assets from runtime
- **No duplication**: No separate help content to maintain

### 2. Enhanced Command Metadata

Commands get an optional `tags` array for flexible categorization. Tags recognized by the help and discovery systems:

- `help-command`: Commands that provide help functionality
- `discovery-command`: Commands that provide discovery/metadata functionality

Plugins can use additional domain-specific tags as needed.

### 3. Separation of Concerns

- **Human-readable help**: `help` and `help-*` commands provide formatted, user-friendly output
- **Machine-readable data**: `discover` and `discover-*` commands provide structured data for programmatic use
- **Plugin-extensible**: Each plugin may export its own help and/or discovery commands

### 4. CLI Integration

When OR-Q is invoked with no arguments:

1. Output brief standard cli usage header
2. Check if `help` command exists in the runtime
3. If yes, execute it on general principles
4. If no, show a generic fallback message: `help command not available, install the @or-q/plugin-help npm package`

## Motivation

### Why This Approach

OR-Q's current help situation is problematic:

1. **User Onboarding**: New users cannot discover available functionality
2. **Plugin Discovery**: No way to understand what plugins provide
3. **Script Visibility**: YAML scripts are invisible without prior knowledge
4. **Developer Experience**: Plugin authors have no standard way to expose help
5. **Architectural Debt**: It is best to introduce breaking changes early

### Why Not Hierarchical Commands

A seemingly elegant alternative would be `help commands`, `help plugins`, etc. However, this is architecturally
impossible due to the way OR-Q's stack-based argument consumption is currently implemented:

The `help` command cannot determine if `commands` is an argument for the help command (e.g., "show me help about
commands") or a legitimate command name that should be left for the next pipeline stage.

## Future Work

After planned switch to the CS-correct program form, `help` command may become porcelain for other
`help-command-plumbing` commands, supporting the elegant alternative above.

## Code Impact Remarks

Non-exhaustive assessment.

### Core

- Remove `IPluginRuntime.usage()`
- Add mandatory `description` field on Plugin, and refactor all plugins to expose pkg.description sans `OR-Q Plugin:`
  through it
- Add `description: pkg.description` to every plugin `index.ts`
- Add optional `tags` field on Command as array of strings
- Add mandatory `usage` field on Command, and refactor all commands to expose it
- Add appropriate lookup dictionaries to `PluginRuntime` class

### New Plugins

- Add `@or-q/cli` dependency on `@or-q/help`
- export `tagHelpCommand` constant from `@or-q/plugin-help` and use it in help command definitions
- export `tagDiscoverCommand` constant from `@or-q/plugin-discover` and use it in discover command definitions

### Command Usage Refactoring

The main challenge of the Proposal is to address implicit technical debt of the command `usage`, which is currently
hardcoded in `Command.run()` implementations without violating DRY on usage text, given that the core as written now
does not currently "know" which command is being executed.

We address that by sidestepping the problem and improving the code layout at the same time, while incidentally ticking a
couple of pre-existing `TODO.md` items:

1. Reorganize code of each plugin:
   - The `src/index.ts` is the plugin definition, commands are defined in other files. Reference:
     [@or-q/plugin-core/index.ts](../../../packages/plugin-core/src/index.ts)

   - One file per command, commands are in `src/commmands/`.

   - If a plugin already had commands in separate files (e.g. `src/debug.ts`), place commands from it as files in a
     subdirectory (e.g. `src/debug/dump.ts`).

2. Define `usage` string as a contant in outer scope of a command implementation file.

Pros:

- Much better command list and command source discoverability
- `usage` is written once, and then referenced both in `run` and in `Command.usage`

Cons:

- Unwieldy `index.ts` barrel-like files, which is acceptable.

## Testing Strategy

Manual smoke tests.

Write dumb `test-<commmand>.yaml` scripts for each command.

Run the script, study the output.

## Proposal Implementation Strategy

Recommendations

1. TBD

### Future work

The scripts will later become a basis for initial test suites.
