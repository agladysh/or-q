# TODO: Implement static cache populated/updated based on git repo and working copy changes

requires:
  - '@or-q/plugin-core'
  - '@or-q/plugin-fetch' # TODO: Migrate general openai conversation stuff from there and update this dependency
  - '@or-q/plugin-store'
  - '@or-q/plugin-jp'

commands:
  - run: fetch-gemini-2.5-flash-instruct

  - glob3:
      - - _DATA: '**/*'
      - - _DATA:
            - '**/.git/**'
      - - _DATA:
            dot: true
  - ignore:
      - - cat: .gitignore
        - append: |
            pnpm-lock.yaml

  - save: FILENAMES

  - dirtree
  - save: DIRTREE

  - load: FILENAMES
  - stream-map:
      - - save: FILENAME
        - t: |
            <file path=${ load FILENAME quote }>
            ${ load FILENAME file trim }
            </file>
  - save: FILES
  - $macro:
      - - $fetch-gemini-2.5-flash-instruct
        - You are a pedantic erudite best-of-field CTO, excelling in technical documentation
        - - t: | # markdown
              Study the codebase:
              <codebase>
              ${ load FILES }
              </codebase>

              Read the dirtree for the codebase:
              <dirtree>
              ${ load dirtree }
              </dirtree>

              Respond with annotated dirtree, containing concise informative descriptions of the files and directories.

              Put annotations after colon on the same line as the annotated item.

              ```
              ...
              ├─ pnpm-workspace.yaml: workspace packages in packages/*, lefthook is a built dependency
              ...
              ├─ packages/: workspace packages
              ...
              ```

              The structure and order of lines in your response must match exactly the original <dirtree/> content.
              Go line by line and add only annotations.

              Your response will be processed by an automated system. Do not include any additional information,
              respond only with the raw annotated dirtree text, no xml tags or Markdown fence blocks are allowed.

  - prepend:
      - - t: | # markdown
            # Project Directory Tree

            > [!WARNING] _This document was generated by an AI and may contain mistakes._

            - Generated-On: ${ shell "date +'%Y-%m-%d'"}
            - Generated-For: ${ shell "git describe --always"}
            - Generated-By: `pnpm or-q run repo-dirtree > docs/agents/dirtree.md`

            ```text
  - append: '```'
